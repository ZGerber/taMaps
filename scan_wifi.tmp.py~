import subprocess
import re
import json
from datetime import datetime

def parse_iwlist_output(output):
    cells = output.split("Cell ")
    results = []

    for cell in cells[1:]:  # Skip first item, it's preamble
        result = {}

        address = re.search(r"Address: ([\w:]+)", cell)
        essid = re.search(r'ESSID:"([^"]+)"', cell)
        signal = re.search(r"Signal level=(-?\d+) dBm", cell)
        quality = re.search(r"Quality=([\d/]+)", cell)
        freq = re.search(r"Frequency:([\d\.]+ [GMkHz]+)", cell)
        channel = re.search(r"Channel:(\d+)", cell)
        encryption = re.search(r"Encryption key:(on|off)", cell)
        mode = re.search(r"Mode:(\w+)", cell)
        bitrates = re.findall(r"Bit Rates:(.+)", cell)

        result["bssid"] = address.group(1) if address else "Hidden"
        result["ssid"]  = essid.group(1) if essid else "Hidden"
        
        if signal: result["signal"] = int(signal.group(1))
        if quality: result["quality"] = quality.group(1)
        if freq: result["frequency"] = freq.group(1)
        if channel: result["channel"] = int(channel.group(1))
        if encryption: result["encryption"] = encryption.group(1)
        if mode: result["mode"] = mode.group(1)
        if bitrates:
            # Flatten and split all bitrates
            rates = []
            for line in bitrates:
                rates.extend(rate.strip() for rate in line.split(";") if rate.strip())
            result["bit_rates"] = rates

        result["esimated_distance_m"] = estimate_distance(result['signal'], result['frequency'])
        result["timestamp"] = datetime.utcnow().replace(microsecond=0).isoformat() + "Z"
        results.append(result)

    return results


def estimate_distance(signal_dbm, freq_mhz, path_loss_exp=3.0):
    return 10 ** ((27.55 - (20 * math.log10(freq_mhz)) + abs(signal_dbm)) / (10 * path_loss_exp))


def scan_wifi(interface="wlx00c0cab6949f"):
    try:
        result = subprocess.run(["iwlist", interface, "scan"], capture_output=True, text=True, timeout=10)
        if result.returncode != 0:
            raise RuntimeError(f"Scan failed: {result.stderr}")
        return parse_iwlist_output(result.stdout)
    except Exception as e:
        print(f"Error during scan: {e}")
        return []


def save_json(data, filename="wifi_scan_log.json"):
    import os
    if os.path.exists(filename):
        with open(filename, "r") as f:
            existing = json.load(f)
    else:
        existing = []

    existing.extend(data)
    with open(filename, "w") as f:
        json.dump(existing, f, indent=2)
    print(f"Appended {len(data)} entries to {filename}")


if __name__ == "__main__":
    interface = "wlx00c0cab6949f"  # Change to your adapter name
    wifi_data = scan_wifi(interface)
    save_json(wifi_data)
